import { db } from '@/firebase/config';
import { TraceabilityService } from '@/services/shared/TraceabilityService';
import type {
  QuestionResponse,
  Survey,
  SurveyFormData,
  SurveyResponseData,
  SurveyResponseFormData,
} from '@/types/surveys';
import { CUSTOMER_SATISFACTION_QUESTIONS } from '@/types/surveys';
import {
  addDoc,
  collection,
  deleteDoc,
  doc,
  getDoc,
  getDocs,
  orderBy,
  query,
  Timestamp,
  updateDoc,
  where,
} from 'firebase/firestore';

const COLLECTION_NAME = 'surveys';
const RESPONSES_COLLECTION = 'survey_responses';

export class SurveyService {
  // ============================================
  // CREATE SURVEY
  // ============================================
  static async create(
    data: SurveyFormData,
    userId: string,
    userName: string
  ): Promise<string> {
    try {
      const year = new Date().getFullYear();
      const surveyNumber = await TraceabilityService.generateNumber(
        'ENC',
        year
      );

      const now = Timestamp.now();

      const surveyData: Omit<Survey, 'id'> = {
        surveyNumber,
        title: data.title,
        type: data.type,
        status: 'active',
        questions: CUSTOMER_SATISFACTION_QUESTIONS,
        responseCount: 0,
        createdAt: now.toDate(),
        updatedAt: now.toDate(),
        createdBy: userId,
        createdByName: userName,
        relatedOrderId: data.relatedOrderId,
        relatedOrderNumber: data.relatedOrderNumber,
      };

      const docRef = await addDoc(collection(db, COLLECTION_NAME), surveyData);
      return docRef.id;
    } catch (error) {
      console.error('Error creating survey:', error);
      throw new Error('Error al crear la encuesta');
    }
  }

  // ============================================
  // GET SURVEY BY ID
  // ============================================
  static async getById(id: string): Promise<Survey | null> {
    try {
      const docRef = doc(db, COLLECTION_NAME, id);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        return null;
      }

      return {
        id: docSnap.id,
        ...docSnap.data(),
      } as Survey;
    } catch (error) {
      console.error('Error getting survey:', error);
      throw new Error('Error al obtener la encuesta');
    }
  }

  // ============================================
  // LIST SURVEYS
  // ============================================
  static async list(): Promise<Survey[]> {
    try {
      const q = query(
        collection(db, COLLECTION_NAME),
        orderBy('createdAt', 'desc')
      );

      const querySnapshot = await getDocs(q);

      return querySnapshot.docs.map(
        doc =>
          ({
            id: doc.id,
            ...doc.data(),
          }) as Survey
      );
    } catch (error) {
      console.error('Error listing surveys:', error);
      throw new Error('Error al listar encuestas');
    }
  }

  // ============================================
  // ADD RESPONSE
  // ============================================
  static async addResponse(
    surveyId: string,
    data: SurveyResponseFormData
  ): Promise<string> {
    try {
      const now = Timestamp.now();

      const responseData: Omit<SurveyResponseData, 'id'> = {
        surveyId,
        clientName: data.clientName,
        clientEmail: data.clientEmail,
        responses: data.responses,
        comments: data.comments,
        createdAt: now.toDate(),
      };

      const docRef = await addDoc(
        collection(db, RESPONSES_COLLECTION),
        responseData
      );

      // Update survey response count and average
      await this.updateSurveyStats(surveyId);

      return docRef.id;
    } catch (error) {
      console.error('Error adding survey response:', error);
      throw new Error('Error al guardar la respuesta');
    }
  }

  // ============================================
  // GET RESPONSES FOR SURVEY
  // ============================================
  static async getResponses(surveyId: string): Promise<SurveyResponseData[]> {
    try {
      const q = query(
        collection(db, RESPONSES_COLLECTION),
        where('surveyId', '==', surveyId),
        orderBy('createdAt', 'desc')
      );

      const querySnapshot = await getDocs(q);

      return querySnapshot.docs.map(
        doc =>
          ({
            id: doc.id,
            ...doc.data(),
          }) as SurveyResponseData
      );
    } catch (error) {
      console.error('Error getting survey responses:', error);
      throw new Error('Error al obtener respuestas');
    }
  }

  // ============================================
  // UPDATE SURVEY STATS
  // ============================================
  private static async updateSurveyStats(surveyId: string): Promise<void> {
    try {
      const responses = await this.getResponses(surveyId);
      const responseCount = responses.length;

      // Calculate average rating across all questions and responses
      let totalRating = 0;
      let totalQuestions = 0;

      responses.forEach(response => {
        response.responses.forEach((qr: QuestionResponse) => {
          // Only count scale responses for average
          if (qr.type === 'scale') {
            totalRating += qr.value;
            totalQuestions++;
          }
        });
      });

      const averageRating =
        totalQuestions > 0 ? totalRating / totalQuestions : undefined;

      const docRef = doc(db, COLLECTION_NAME, surveyId);
      await updateDoc(docRef, {
        responseCount,
        averageRating,
        updatedAt: Timestamp.now().toDate(),
      });
    } catch (error) {
      console.error('Error updating survey stats:', error);
    }
  }

  // ============================================
  // COMPLETE SURVEY
  // ============================================
  static async complete(surveyId: string): Promise<void> {
    try {
      const docRef = doc(db, COLLECTION_NAME, surveyId);
      await updateDoc(docRef, {
        status: 'completed',
        updatedAt: Timestamp.now().toDate(),
      });
    } catch (error) {
      console.error('Error completing survey:', error);
      throw new Error('Error al completar la encuesta');
    }
  }

  // ============================================
  // DELETE SURVEY
  // ============================================
  static async delete(id: string): Promise<void> {
    try {
      const docRef = doc(db, COLLECTION_NAME, id);
      await deleteDoc(docRef);
    } catch (error) {
      console.error('Error deleting survey:', error);
      throw new Error('Error al eliminar la encuesta');
    }
  }
}
